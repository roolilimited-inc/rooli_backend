generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  password     String? // Optional for OAuth users
  firstName    String?
  lastName     String?
  avatar       String?
  userType     UserType @default(INDIVIDUAL)
  timezone     String?  @default("Africa/Lagos")
  isOnboardingComplete Boolean @default(false)
  systemRoleId String?
  systemRole   Role?    @relation("UserSystemRole", fields: [systemRoleId], references: [id])

lastVerificationEmailSentAt DateTime?

  // Tracks which Workspace (Client) the user was looking at last
  lastActiveWorkspaceId    String?
  lastActiveWorkspace      Workspace?    @relation("UserLastActiveWorkspace", fields: [lastActiveWorkspaceId], references: [id], onDelete: SetNull)

  // Email verification
  isEmailVerified         Boolean   @default(false)
  refreshToken            String?

  // Security
  loginAttempts       Int       @default(0)
  lockedUntil         DateTime?
  lastPasswordChange  DateTime?
  refreshTokenVersion Int       @default(0)

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?
  lastActiveAt DateTime?

  mediaFiles              MediaFile[]
  organizationMemberships OrganizationMember[] @relation("UserOrganizationMemberships")
  workspaceMemberships  WorkspaceMember[]

 sentInvitations         Invitation[] @relation("UserSentInvitations")

  aiContentGenerations     AiContentGeneration[]
  aiImageGenerations       AiImageGeneration[]
  // messages                 Message[]
  // notifications            NotificationEntity[]
  ContentTemplate          ContentTemplate[]
  Post                     Post[]
  approvalsRequested       PostApproval[]            @relation("ApprovalRequester")
  approvalsGiven           PostApproval[]            @relation("ApprovalApprover")
  auditLogs                AuditLog[]
  aiUsages                 AIUsage[]
  favoriteTemplates        UserFavoriteTemplate[]
  //conversationParticipants ConversationParticipant[]


  @@index([email, deletedAt])
  @@index([createdAt])
  @@index([lastActiveAt])
}

model Organization {
  id               String   @id @default(cuid())
  name             String
  email            String?
  timezone         String  @default("Africa/Lagos") //All scheduling logic (cron jobs, "best time to post" AI) defaults to this timezone.
  slug             String   @unique
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  isActive         Boolean  @default(true)
 // Branding
  agencyLogoUrl  String?
  agencyColor    String?
  // Billing & Status
  billingEmail     String?
  billingCountry   String   @default("NG")
  currency         String   @default("NGN")
  status           OrganizationStatus @default(PENDING_PAYMENT)
  totalCreditsUsed Int      @default(0)

  members        OrganizationMember[]
  invitations      Invitation[]

  workspaces       Workspace[]
  socialConnections SocialConnection[]


  aiContentGenerations AiContentGeneration[]
  aiImageGenerations   AiImageGeneration[]
  // conversations        Conversation[]
  // notifications        NotificationEntity[]
  webhookLogs          WebhookLog[]
  PostingSchedule      PostingSchedule[]
  ContentTemplate      ContentTemplate[]
  auditLogs            AuditLog[]

  aiUsages AIUsage[]


  roles        Role[]

  subscriptionGateway  SubscriptionGateway  @default(PAYSTACK)

  subscription Subscription? // 1-to-1 relation
  transactions Transaction[] // Payment history

  settings      Json?

  publishingMetrics PublishingMetric[]

}

model Workspace {
  id             String   @id @default(cuid())
  name           String   // e.g. "Coca Cola Account" or "Personal Brand"
  slug           String   // unique-per-org logic needed in app code, or globally unique
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)


  invitations    Invitation[]
  socialProfiles SocialProfile[]
  
  // Posts belong to a Workspace
  posts          Post[]
  mediaFolders MediaFolder[]
  mediaFiles     MediaFile[]
  brandKit       BrandKit?

  usersActiveHere User[] @relation("UserLastActiveWorkspace")
  
  // --- THE "CLIENT LABEL" FEATURES ---
  // These fields are only used if the Plan allows "clientLabels"
  clientName     String? 
  clientStatus   String?  // "Active", "Onboarding", "Churned"
  clientContact  String?  // "Jane Doe (jane@coke.com)"
  clientColor    String?  // "#FF0000" (To color-code the dashboard card)

  members  WorkspaceMember[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([organizationId, slug]) // Slugs must be unique within an organization
}

model WorkspaceMember {
  id           String    @id @default(cuid())
  workspaceId  String
  userId       String
  roleId       String  

  workspace    Workspace @relation(fields: [workspaceId], references: [id])
  user         User      @relation(fields: [userId], references: [id])
  role         Role      @relation(fields: [roleId], references: [id])

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([workspaceId, userId])
}

model OrganizationMember {
  id             String   @id @default(cuid())
  organizationId String
  userId         String
  roleId         String
  invitedBy      String?
  joinedAt       DateTime @default(now())
  isActive       Boolean  @default(true) // Soft delete flag

  permissions  Json?
  lastActiveAt DateTime?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation("UserOrganizationMemberships", fields: [userId], references: [id], onDelete: Cascade)
  role         Role         @relation(fields: [roleId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, userId])
  @@index([userId, isActive])
  @@index([lastActiveAt])
}

model Invitation {
  id             String   @id @default(cuid())
  email          String
  token          String   @unique // The secret key sent in email
  
  inviterId      String
  inviter        User     @relation("UserSentInvitations", fields: [inviterId], references: [id])
  
  // 2. Which Organization is paying? (Required)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // 3. Which Workspace? (Optional - null means Org-wide invite)
  workspaceId    String? 
  workspace      Workspace?   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)


  roleId         String
  role           Role         @relation(fields: [roleId], references: [id])

    expiresAt      DateTime
  createdAt      DateTime @default(now())
  
  // Prevents sending the exact same invite twice, but allows inviting 
  // the same email to different workspaces within the same Org.
  @@unique([email, organizationId, workspaceId])
}

model SocialConnection {
  id               String   @id @default(cuid())
  organizationId   String
  platform         Platform // FACEBOOK, LINKEDIN, TWITTER
  
  // ðŸ” USER CREDENTIALS (The "Master Key")
  // Used to refresh tokens and fetch list of pages
  platformUserId   String   // The generic User ID (e.g. FB User ID)
  platformUsername String?


  accessToken      String   @db.Text // Encrypted
  refreshToken     String?  @db.Text // Encrypted  //twitter access secret
  tokenExpiresAt   DateTime?

  // Relations
  organization     Organization    @relation(fields: [organizationId], references: [id])
  profiles         SocialProfile[] // One Login -> Many Pages

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([organizationId, platform, platformUserId]) // Prevent duplicate logins
  @@index([organizationId])
}

model SocialProfile {
  id                 String   @id @default(cuid())
  workspaceId        String
  socialConnectionId String   // Link back to the parent login

  platform           Platform
  platformId         String   // The Page ID / IG Business ID
  name               String   // "Nike Official"
  username           String?  // "@nike"
  picture            String?

  followerCount    Int  @default(0)

  // ðŸ” PAGE CREDENTIALS (The "Room Key")
  // Specific token to post to THIS page. 
  // For FB/IG: This is the Page Access Token.
  // For X/LinkedIn: Often a copy of the User Token.
  accessToken        String?  @db.Text 

  type           SocialProfileType

  // Relations
  workspace          Workspace        @relation(fields: [workspaceId], references: [id])
  connection         SocialConnection @relation(fields: [socialConnectionId], references: [id], onDelete: Cascade)
  
  // The posts scheduled for this specific profile
  postDestinations   PostDestination[] 
  
  // Analytics for this specific profile
  //dailyAnalytics     AccountAnalytics[]

  isActive           Boolean  @default(true)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([workspaceId, platform, platformId])
  @@index([workspaceId])
}


model Post {
  id              String      @id @default(cuid())
  authorId        String?
  socialAccountId String
  pageAccountId   String?
  content         String
  contentType     ContentType @default(POST)
  platform        Platform
  mediaFileIds    MediaFile[]
  scheduledAt     DateTime?
  timezone        String
  publishedAt     DateTime?
  status          PostStatus  @default(DRAFT)
  errorMessage    String?
  retryCount      Int         @default(0)
  metadata        Json?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  isAutoSchedule Boolean @default(false)
  // ðŸ”— THE OMNICHANNEL LINK
  destinations  PostDestination[]

  maxRetries Int @default(3)

  // Platform metadata
  platformPostId String? // ID returned by platform after publishing

  parentPostId String? // Points to the previous tweet in the thread
  parentPost   Post?   @relation("PostThread", fields: [parentPostId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  childPosts   Post[]  @relation("PostThread")

  // RELATIONS
  author        User?                   @relation(fields: [authorId], references: [id], onDelete: Cascade)
  approvals     PostApproval[]
  snapShots     PostAnalyticsSnapshot[]

  jobId       String?
  queueStatus ScheduleJobStatus @default(PENDING)

  lastAnalyticsCheck DateTime?
  nextAnalyticsCheck DateTime? @default(now())
  analyticsPriority  Int       @default(1)

  // These represent the LATEST known state.
  // Updated every time you create a new Snapshot.
  currentLikes       Int @default(0)
  currentComments    Int @default(0)
  currentShares      Int @default(0)
  currentImpressions Int @default(0)
  currentReach       Int @default(0)
  currentClicks      Int @default(0)

  // Calculated field for sorting "Best Performing"
  engagementRate Float @default(0.0)

  // AI relations
  aiContentId        String?              @unique
  aiContent          AiContentGeneration? @relation(fields: [aiContentId], references: [id])
  aiImageGenerations AiImageGeneration[]

  //notifications NotificationEntity[]

 workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([socialAccountId, status, scheduledAt])
  @@index([workspaceId, status])
  @@index([status, scheduledAt])
  @@index([status, nextAnalyticsCheck])
  @@index([socialAccountId, scheduledAt])
  @@index([jobId])
}

model PostDestination {
  id              String         @id @default(cuid())
  postId          String
  socialProfileId String         // Which specific account is this for?

  // ðŸŽ¨ PLATFORM SPECIFIC OVERRIDES (Requirement: "AI Copy Suggestions")
  // Allows different text for Twitter (short) vs LinkedIn (long)
  contentOverride String?        @db.Text 

  // Twitter might fail, while Facebook succeeds. We need to track them separately.
  status          PublishStatus  @default(SCHEDULED)
  platformPostId  String?        // The ID given by FB/Twitter after posting (for analytics)
  errorMessage    String?        // "Image aspect ratio not supported"

  post            Post           @relation(fields: [postId], references: [id], onDelete: Cascade)
  profile         SocialProfile  @relation(fields: [socialProfileId], references: [id])

  @@unique([postId, socialProfileId]) // Prevent duplicate sending to same profile
}

model PostApproval {
  id            String         @id @default(cuid())
  postId        String
  requesterId   String
  approverId    String?
  status        ApprovalStatus @default(PENDING)
  comments      String?
  requestedAt   DateTime       @default(now())
  reviewedAt    DateTime?
  revisionNotes String?        @db.Text

  post      Post  @relation(fields: [postId], references: [id], onDelete: Cascade)
  requester User  @relation("ApprovalRequester", fields: [requesterId], references: [id])
  approver  User? @relation("ApprovalApprover", fields: [approverId], references: [id])

  @@unique([postId])
  @@index([status, requestedAt])
  @@index([requesterId, status])
}

model PublishingMetric {
  id             String   @id @default(uuid())
  organizationId String
  platform       Platform
  success        Boolean
  errorMessage   String? // optional, only filled on failure
  timestamp      DateTime @default(now())

  // relations
  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId, platform, timestamp])
}

model MediaFolder {
  id             String  @id @default(cuid())
  name           String
  parentId       String?

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  parent       MediaFolder?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: NoAction)
  children     MediaFolder[] @relation("FolderHierarchy")
  files        MediaFile[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([workspaceId, parentId, name])
  @@index([workspaceId])
  @@index([parentId])
}

model MediaFile {
  id                  String    @id @default(cuid())
  userId              String
  filename            String
  originalName        String
  mimeType            String
  size                BigInt
  url                 String
  publicId            String
  thumbnailUrl        String?
  folderId            String?
  duration            Int?
  metadata            Json?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  expiresAt           DateTime?
  isAIGenerated       Boolean   @default(false)
  aiGenerationContext Json?
  // Not unique to allow multiple files per generation:
  aiGenerationId      String?
  posts               Post[]

  folder MediaFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)

  // Relation field (many media files -> one generation)
  aiImageGeneration AiImageGeneration? @relation(fields: [aiGenerationId], references: [id], onDelete: SetNull)

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([isAIGenerated])
  @@index([workspaceId, isAIGenerated])
}


// The Plan Model (Your Tiers)
model Plan {
  id          String  @id @default(cuid())
  name        String   @unique
  description String?
  tier         PlanTier   @default(CREATOR)


  // BILLING MAPPING
 paystackPlanCodeNgn String? @unique 
 paystackPlanCodeUsd String? @unique

  // PRICING (Display purposes)
  priceNgn      Decimal     @db.Decimal(10, 2) @default(0.00)
  priceUsd      Decimal     @db.Decimal(10, 2) @default(0.00)
  interval      BillingInterval


  // --- LIMITS (The "Guards") ---
  
  // Rocket Plan specific: "Up to 5 workspaces"
  maxWorkspaces Int @default(1) 

  // "Up to 3 social profiles" (Creator) vs "4 per workspace" (Rocket)
  maxSocialProfilesPerWorkspace Int @default(3) 

  // "1 user" (Creator) vs "Unlimited" (Rocket - set to -1 or 9999)
  maxTeamMembers Int @default(1)

  // AI Usage Limits (Credits per month)
  monthlyAiCredits Int @default(100)

// --- FEATURES (Flags) ---
  // JSON stores boolean flags: 
  // { "canRemoveBranding": true, "hasAdvancedAnalytics": true, "hasApprovalWorkflow": true }
  features      Json @default("{}") 

  isActive      Boolean @default(true)
  subscriptions Subscription[]

  // list allowed platforms
  allowedPlatforms Platform[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// The Active Subscription
model Subscription {
  id String @id @default(cuid())

  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id])

  planId String
  plan   Plan   @relation(fields: [planId], references: [id])

// STATUS & PERIOD
  status             String   @default("active") // "active", "past_due", "canceled", "incomplete"
  isActive  Boolean 
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean  @default(false)

  // --- PAYSTACK SPECIFIC FIELDS (NGN) ---
  paystackSubscriptionCode String? // "SUB_vsyqdmlzble3uii"
  paystackEmailToken       String? // "otk_54321" (For one-click actions)
  paystackAuthCode         String? // "AUTH_8dfhgpkv" (CRITICAL: Used to charge card for renewal)

  
  // --- ENTERPRISE MAGIC: CUSTOM LIMITS ---
  // If this is set, these numbers OVERRIDE the Plan defaults.
  // Example: { "maxWorkspaces": 10, "maxTeamMembers": 50 }
  // Logic: const limit = sub.customLimits?.maxWorkspaces || plan.maxWorkspaces
  customLimits             Json?   

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
// Transaction History (Invoices)
model Transaction {
  id String @id @default(cuid())

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  amount      Decimal @db.Decimal(10, 2)
  currency    String
  status      String // successful, failed, abandoned

  txRef    String   @unique

  // PROVIDER DETAILS
  provider     String   // "PAYSTACK"
  providerTxId String   // Paystack "reference"


  
  // Detailed breakdown
  metadata     Json?    // Store extra JSON from webhook (e.g. IP address, card type)

  paymentDate  DateTime @default(now())
  
  // Link to a specific subscription period if needed for auditing
  subscriptionId String?
  invoiceUrl     String?

   createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AiContentGeneration {
  id             String      @id @default(cuid())
  organizationId String
  userId         String
  platform       Platform
  contentType    ContentType
  topic          String
  tone           ToneType
  creditsUsed    Int

  prompt        String   @db.Text
  generatedText String   @db.Text
  hashtags      String[]

  cost      Float    @default(0)
  provider  String
  model     String
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Post relation (moved to Post as aiContentId)
  post Post?

  brandKitId String?
  brandKit   BrandKit? @relation(fields: [brandKitId], references: [id], onDelete: SetNull)

  @@index([organizationId, createdAt])
  @@index([userId])
}

model AiImageGeneration {
  id             String   @id @default(cuid())
  organizationId String
  userId         String
  prompt         String   @db.Text
  creditsUsed    Int
  imageUrl       String?
  publicId       String?
  revisedPrompt  String?  @db.Text
  cost           Float    @default(0)
  provider       String
  model          String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @default(now())

  mediaFiles MediaFile[]

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  postId String?
  post   Post?   @relation(fields: [postId], references: [id])

  brandKitId String?
  brandKit   BrandKit? @relation(fields: [brandKitId], references: [id], onDelete: SetNull)

  @@index([organizationId, createdAt])
}

model AIUsage {
  id             String   @id @default(cuid())
  organizationId String
  userId         String
  type           String // 'content_generation' | 'image_generation'
  tokensUsed     Int
  cost           Float
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt])
}

// Conversation = a thread of messages with a user on a platform
// model Conversation {
//   id                 String    @id @default(cuid())
//   organizationId     String
//   platform           Platform
//   externalId         String
//   subject            String?
//   createdAt          DateTime  @default(now())
//   updatedAt          DateTime  @updatedAt
//   lastMessageAt      DateTime?
//   lastMessagePreview String?
//   unreadCount        Int       @default(0)
//   externalUserId     String
//   externalUsername   String?
//   tags               String[]
//   // ADD: Social account context for permission checks
//   socialAccountId    String?

//   organization  Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
//   socialAccount SocialAccount?            @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)
//   messages      Message[]
//   // ADD: Track participants for efficient notification targeting
//   participants  ConversationParticipant[]

//   @@unique([organizationId, platform, externalId])
//   @@index([socialAccountId]) // ADD
//   @@index([lastMessageAt]) // ADD for sorting
//   @@index([platform, organizationId]) // ADD
// }

// // NEW: Track conversation participants
// model ConversationParticipant {
//   id             String    @id @default(cuid())
//   conversationId String
//   userId         String
//   joinedAt       DateTime  @default(now())
//   lastReadAt     DateTime? // For read receipts

//   conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
//   user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

//   @@unique([conversationId, userId])
//   @@index([userId])
// }

// model Message {
//   id             String        @id @default(cuid())
//   conversationId String
//   senderId       String?
//   externalSender String?
//   content        String?
//   mediaUrl       String?
//   status         MessageStatus @default(UNREAD)
//   sentAt         DateTime
//   createdAt      DateTime      @default(now())

//   conversation  Conversation         @relation(fields: [conversationId], references: [id], onDelete: Cascade)
//   sender        User?                @relation(fields: [senderId], references: [id], onDelete: SetNull)
//   notifications NotificationEntity[]

//   // ADD indexes for efficient querying
//   @@index([conversationId, sentAt]) // For loading conversation messages
//   @@index([sentAt]) // For global search/sorting
// }

model ContentTemplate {
  id             String  @id @default(cuid())
  organizationId String?
  userId         String
  name           String
  description    String?
  version        Int     @default(1) // For template versioning

  // Template metadata
  platform    Platform
  contentType ContentType
  category    TemplateCategory
  tags        String[]

  // Template content - enhanced structure
  content   Json // TemplateContent structure
  example   String? @db.Text // Example filled template
  variables Json? // Variable definitions for validation

  // Status & usage
  isPublic      Boolean        @default(false)
  status        TemplateStatus @default(DRAFT)
  usageCount    Int            @default(0)
  lastUsedAt    DateTime?
  favoriteCount Int            @default(0) // Track popularity

  // Brand integration
  brandKitId String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  brandKit     BrandKit?     @relation(fields: [brandKitId], references: [id], onDelete: SetNull)

  // Add template favorites for users
  favorites UserFavoriteTemplate[]

  @@index([organizationId, platform, contentType])
  @@index([isPublic, platform, category, status])
  @@index([userId, status])
  @@index([tags])
  @@index([brandKitId])
  @@index([favoriteCount]) // For popular templates
  @@index([usageCount]) // For most used templates
}

// Add favorite system
model UserFavoriteTemplate {
  id         String   @id @default(cuid())
  userId     String
  templateId String
  createdAt  DateTime @default(now())

  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  template ContentTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([userId, templateId])
  @@index([userId])
  @@index([templateId])
}

model PlatformRateLimitLog {
  id              String   @id @default(cuid())
  platform        Platform
  socialAccountId String
  requestType     String // e.g. "post", "dm", "comment"
  consumedAt      DateTime @default(now())
  windowStart     DateTime
  windowEnd       DateTime
  status          String // "allowed" | "blocked"

  @@index([platform, socialAccountId, windowStart, windowEnd])
}

// ========================
// ANALYTICS & REPORTING
// ========================

model PostAnalyticsSnapshot {
  id     String @id @default(cuid())
  postId String

  recordedAt DateTime @default(now())

  likes       Int @default(0)
  comments    Int @default(0)
  shares      Int @default(0)
  impressions Int @default(0)
  reach       Int @default(0)
  clicks      Int @default(0)

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId, recordedAt])
}

// Store daily aggregate data for the Account/Page itself
model AccountAnalytics {
  id String @id @default(cuid())

  // Link to either SocialAccount (X/LinkedIn Profile) or PageAccount (FB/IG Page)
  socialAccountId String?
  pageAccountId   String?

  date     DateTime @db.Date // The specific day this data represents
  platform Platform

  // Growth
  followersTotal  Int @default(0)
  followersGained Int @default(0)
  followersLost   Int @default(0)

  // Reach & Traffic (Account Level)
  impressions   Int @default(0) // Total views of all content + profile
  reach         Int @default(0) // Unique people
  profileViews  Int @default(0)
  websiteClicks Int @default(0)

  // Engagement (Aggregate)
  engagementCount Int @default(0) // Sum of all interactions that day

  // Relations
  // socialAccount SocialAccount? @relation(fields: [socialAccountId], references: [id])
  // pageAccount   PageAccount?   @relation(fields: [pageAccountId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@unique([socialAccountId, platform, date])
  @@unique([pageAccountId, platform, date])
  @@index([date])
}

// ========================
// WEBHOOK & INTEGRATION
// ========================

model WebhookLog {
  id String @id @default(cuid())

  provider   String // "FLUTTERWAVE", "META", "LINKEDIN"
  resourceId String? // The Payment Ref or User ID involved
  eventType  String? // "charge.completed", "permissions_revoked"

  payload Json // The FULL raw body sent by the provider

  status       WebhookStatus @default(PENDING) // PENDING, PROCESSED, FAILED, IGNORED
  errorMessage String?

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  processedAt DateTime?
  createdAt   DateTime  @default(now())

  @@index([provider, status])
  @@index([createdAt])
}

model PostingSchedule {
  id             String         @id @default(cuid())
  organizationId String
  platform       Platform
  timezone       String         @default("UTC")
  isActive       Boolean        @default(true)
  lastUpdated    DateTime       @default(now())
  source         ScheduleSource @default(AI_RECOMMENDATION)
  optimalTimes   Json // { monday: [9, 14, 18], tuesday: [10, 16], ... }
  excludedDates  String[] // ["2024-12-25", "2024-01-01"]
  maxPostsPerDay Int            @default(5)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, platform])
  @@index([isActive, platform])
}

// model NotificationEntity {
//   id              String               @id @default(cuid())
//   userId          String
//   organizationId  String
//   type            NotificationType
//   socialAccountId String?
//   title           String
//   content         String
//   data            Json? // Flexible data storage
//   priority        NotificationPriority @default(NORMAL)
//   read            Boolean              @default(false)
//   readAt          DateTime?
//   expiresAt       DateTime? // Auto-cleanup of old notifications
//   createdAt       DateTime             @default(now())

//   // Relations
//   user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
//   organization  Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
//   message       Message?       @relation(fields: [messageId], references: [id], onDelete: SetNull)
//   post          Post?          @relation(fields: [postId], references: [id], onDelete: SetNull)
//   socialAccount SocialAccount? @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)

//   // Optional references
//   messageId String?
//   postId    String?

//   @@index([userId, read])
//   @@index([createdAt])
//   @@index([expiresAt])
// }

enum NotificationType {
  MESSAGE_RECEIVED
  MENTION
  POST_APPROVAL
  SCHEDULE_REMINDER
  PERFORMANCE_ALERT
  SYSTEM_ALERT
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model AuditLog {
  id             String   @id @default(cuid())
  organizationId String
  userId         String // Who performed the action
  action         String // "member_invited", "member_removed", "plan_changed"
  resourceType   String // "organization", "member", "invitation"
  resourceId     String? // ID of the affected resource
  details        Json? // { oldRole: "MEMBER", newRole: "ADMIN" }
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt])
  @@index([action, resourceType])
}

model BrandKit {
  id             String @id @default(cuid())
  workspaceId    String  @unique
  name           String @default("Our Brand")
  version        Int    @default(1) // For version tracking

  // Visual identity - flexible JSON structure
  logoUrl String?
  colors  Json? // { primary: "#1E40AF", secondary: "#F59E0B", ... }

  // Brand voice
  brandVoice String? @db.VarChar(500)
  tone       String? // Could use enum or free text
  guidelines Json? // Additional brand guidelines

  // Status
  isActive  Boolean  @default(true)
  isDefault Boolean  @default(false) // Mark as default brand kit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
    workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  aiContentGenerations AiContentGeneration[]
  aiImageGenerations   AiImageGeneration[]
  ContentTemplate      ContentTemplate[]

  @@index([isActive])
}

model Permission {
  id          String             @id @default(cuid())
  name        String
  description String?
  scope       PermissionScope
  resource    PermissionResource
  action      PermissionAction

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  rolePermissions RolePermission[]

  @@unique([scope, resource, action])
  @@index([scope])
}

model Role {
  id             String    @id @default(cuid())
  name           String
  slug           String?
  description    String?
  isSystem       Boolean   @default(false) // System roles cannot be deleted
  isDefault      Boolean   @default(false) // Default role for new members
  organizationId String?
  displayName    String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  scope          RoleScope

  invitations             Invitation[]

  // Relations
  organization            Organization?            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  systemUsers             User[]                   @relation("UserSystemRole")
  permissions             RolePermission[]
  organizationMembers     OrganizationMember[]
  workspaceMembers        WorkspaceMember[]

  @@unique([scope, organizationId, name])
  @@index([isSystem, isDefault])
}

model RolePermission {
  id           String @id @default(cuid())
  roleId       String
  permissionId String

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
}

enum SocialProfileType {
  FACEBOOK_PAGE
  INSTAGRAM_BUSINESS
  LINKEDIN_PAGE
  LINKEDIN_PROFILE
  TWITTER_PROFILE
}

enum UserType {
  INDIVIDUAL // Regular business (1 Org limit)
  AGENCY // Manages multiple clients (Multiple Orgs allowed)
}

enum PostStatus {
  DRAFT
  PENDING_APPROVAL
  SCHEDULED
  PUBLISHED
  PARTIALLY_PUBLISHED
  FAILED
}

enum PublishStatus {
  SCHEDULED
  PUBLISHING
  SUCCESS
  FAILED
}

enum RoleScope {
  SYSTEM
  ORGANIZATION
  WORKSPACE
}

enum QueueStatus {
  PENDING
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
  RETRYING
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  CHANGES_REQUESTED
}

enum ScheduleSource {
  MANUAL
  AI_RECOMMENDATION
  PLATFORM_INSIGHTS
}

enum CreditType {
  PURCHASE
  USAGE
  REFUND
  BONUS
  ADJUSTMENT
}

enum PlanTier {
  CREATOR
  BUSINESS
  ROCKET
  ENTERPRISE
}

enum PlanStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING
}

enum BillingInterval {
  MONTHLY
  YEARLY
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE
}

enum OrganizationStatus {
  PENDING_PAYMENT // Created but not paid yet
  ACTIVE // Paid and running
  SUSPENDED // Ban or failed payments
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
  DECLINED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  INVITE
  LOGIN
  EXECUTE
}

enum MessageStatus {
  UNREAD
  READ
  DELIVERED
  FAILED
}

enum Platform {
  TWITTER
  LINKEDIN
  FACEBOOK
  INSTAGRAM
}

enum ScheduleJobStatus {
  PENDING
  PROCESSING
  SCHEDULED
  FAILED
  CANCELLED
  QUEUED
  PUBLISHED
  RETRYING
}

enum ContentType {
  POST
  STORY
  REEL
  CAROUSEL
  THREAD
}

enum ToneType {
  PROFESSIONAL
  CASUAL
  WITTY
  EXCITED
  INSPIRATIONAL
  EDUCATIONAL
}

enum AspectRatio {
  SQUARE    @map("1:1")
  LANDSCAPE @map("16:9")
  PORTRAIT  @map("4:5")
  VERTICAL  @map("9:16")
}

enum ReportType {
  ENGAGEMENT
  PERFORMANCE
  AUDIENCE
  COMPETITOR
  CUSTOM
}

enum ReportFormat {
  JSON
  PDF
  EXCEL
  CSV
}

enum ReportStatus {
  GENERATING
  COMPLETED
  FAILED
}

enum WebhookEventType {
  POST_PUBLISHED
  POST_DELETED
  COMMENT_RECEIVED
  MESSAGE_RECEIVED
  MENTION_RECEIVED
  FOLLOWER_GAINED
  FOLLOWER_LOST
  ENGAGEMENT
}

enum BrandColorType {
  PRIMARY
  SECONDARY
  ACCENT
  NEUTRAL
  SUCCESS
  WARNING
  ERROR
}

enum FontCategory {
  HEADING
  BODY
  ACCENT
}

enum BrandVoice {
  PROFESSIONAL
  CASUAL
  WITTY
  ENTHUSIASTIC
  AUTHORITATIVE
  FRIENDLY
  INSPIRATIONAL
}

enum EngagementType {
  LIKE
  COMMENT
  SHARE
  MENTION
  REACTION
}

enum GenerationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PermissionScope {
  SYSTEM
  ORGANIZATION // Organization-wide permissions
  WORKSPACE
}

enum PermissionResource {
  ALL
  SYSTEM
  // Organization resources
  ORGANIZATION
  MEMBERS
  BILLING
  SETTINGS
  SUBSCRIPTION
  INTEGRATION

  // Social media resources
  POSTS
  DRAFT
  CONTENT
  SCHEDULING
  ANALYTICS
  MESSAGE
  COMMENT

  // Team resources
  INVITATIONS
  AUDIT_LOGS

  AI_CONTENT
  AI_USAGE
  TEMPLATE
  SCHEDULE
  CALENDAR
  INBOX
}

enum PermissionAction {
  ALL
  CREATE
  READ
  UPDATE
  DELETE
  MANAGE
  APPROVE
  PUBLISH
  EXPORT
}

enum TemplateCategory {
  PROMOTIONAL
  EDUCATIONAL
  ENGAGEMENT
  ANNOUNCEMENT
  EVENT
  PRODUCT
  TESTIMONIAL
  UGC
  HOLIDAY
  INDUSTRY_NEWS
}

enum TemplateStatus {
  DRAFT
  ACTIVE
  ARCHIVED
  DELETED
}

enum WebhookStatus {
  PENDING
  PROCESSED
  FAILED
  IGNORED
}

enum SubscriptionGateway {
  PAYSTACK
  STRIPE
}
